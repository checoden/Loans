# Руководство по устранению неполадок

В этом руководстве описаны основные проблемы, которые могут возникнуть при работе с приложением "Займы онлайн", и способы их решения.

## Содержание

1. [Проблемы с запуском приложения](#проблемы-с-запуском-приложения)
2. [Проблемы с push-уведомлениями](#проблемы-с-push-уведомлениями)
3. [Проблемы со сборкой APK](#проблемы-со-сборкой-apk)
4. [Проблемы с интерфейсом](#проблемы-с-интерфейсом)
5. [Конфликты портов](#конфликты-портов)

## Проблемы с запуском приложения

### Ошибка "EADDRINUSE: address already in use"

**Проблема**: При запуске приложения возникает ошибка "EADDRINUSE: address already in use".

**Решение**:
1. Выполните команду для поиска процесса, занимающего порт 5000:
   ```bash
   lsof -i :5000
   ```

2. Завершите найденный процесс:
   ```bash
   kill -9 <PID>
   ```

3. Запустите приложение снова:
   ```bash
   npm run dev
   ```

### Ошибка "Module not found"

**Проблема**: При запуске приложения возникает ошибка "Cannot find module..."

**Решение**:
1. Установите зависимости заново:
   ```bash
   npm install
   ```

2. Очистите кэш npm:
   ```bash
   npm cache clean --force
   ```

3. Запустите приложение:
   ```bash
   npm run dev
   ```

## Проблемы с push-уведомлениями

### Не отправляются уведомления

**Проблема**: Уведомления не отправляются или не приходят.

**Решение**:
1. Проверьте наличие переменных окружения:
   ```bash
   echo $VITE_ONESIGNAL_APP_ID
   echo $VITE_ONESIGNAL_REST_API_KEY
   ```

2. Проверьте статус OneSignal:
   - Зайдите на https://app.onesignal.com/
   - Проверьте, что ваше приложение активно

3. Проверьте консоль на наличие ошибок при отправке уведомлений.

### Ошибка "API Key is invalid"

**Проблема**: При отправке уведомлений появляется ошибка "API Key is invalid".

**Решение**:
1. Проверьте значение ключа API в административной панели:
   - Войдите в OneSignal Dashboard
   - Перейдите в Settings > Keys & IDs
   - Скопируйте REST API Key

2. Обновите переменную окружения:
   ```bash
   export VITE_ONESIGNAL_REST_API_KEY="ваш_новый_ключ"
   ```

3. Перезапустите приложение.

## Проблемы со сборкой APK

### Ошибка "Capacitor not installed"

**Проблема**: При сборке APK возникает ошибка, связанная с Capacitor.

**Решение**:
1. Установите Capacitor глобально:
   ```bash
   npm install -g @capacitor/cli
   ```

2. Установите необходимые пакеты:
   ```bash
   npm install @capacitor/core @capacitor/android
   ```

3. Запустите скрипт подготовки заново:
   ```bash
   node prepare-for-apk.js
   ```

### Ошибка "Google Services plugin not applied"

**Проблема**: При сборке APK в Android Studio возникает ошибка Google Services.

**Решение**:
1. Убедитесь, что файл `google-services.json` находится в правильной директории:
   ```bash
   ls -la android/app/
   ```

2. Если файла нет, используйте шаблон:
   ```bash
   cp client/google-services.json.template android/app/google-services.json
   ```

3. Для работы с реальными push-уведомлениями замените этот файл на реальный, полученный из Firebase Console.

### Ошибка "SDK Location not found"

**Проблема**: Android Studio не может найти SDK.

**Решение**:
1. Создайте файл `local.properties` в директории android:
   ```bash
   echo "sdk.dir=/путь/к/android/sdk" > android/local.properties
   ```

2. Или укажите путь в Android Studio:
   - File > Project Structure > SDK Location

## Проблемы с интерфейсом

### Не загружаются логотипы МФО

**Проблема**: Логотипы МФО не отображаются в списке займов.

**Решение**:
1. Проверьте, что файлы логотипов существуют:
   ```bash
   ls -la public/logos/
   ```

2. Убедитесь, что пути к логотипам указаны правильно в данных:
   ```bash
   curl http://localhost:5000/api/loans
   ```

3. Проверьте консоль браузера на наличие ошибок загрузки.

### Проблемы со стилями

**Проблема**: Стили не применяются или отображаются некорректно.

**Решение**:
1. Обновите зависимости:
   ```bash
   npm install tailwindcss@latest postcss@latest autoprefixer@latest
   ```

2. Пересоберите стили:
   ```bash
   npx tailwindcss build -i client/src/index.css -o public/styles.css
   ```

3. Перезапустите приложение.

## Конфликты портов

### Основное приложение и push-сервер конфликтуют

**Проблема**: Push-сервер и основное приложение конфликтуют из-за одинакового порта.

**Решение**:
1. Измените порт push-сервера в файле `run-push-server.js`:
   ```javascript
   const PORT = 3000; // Измените на другой, например, 3001
   ```

2. Перезапустите оба сервера:
   ```bash
   ./build-and-run-app.sh
   ```

### Другие сервисы используют порты приложения

**Проблема**: Другие сервисы используют порты 5000 или 3000.

**Решение**:
1. Измените порт основного приложения в `server/index.ts`:
   ```typescript
   const PORT = process.env.PORT || 5001; // Измените порт
   ```

2. Измените порт push-сервера в `run-push-server.js`:
   ```javascript
   const PORT = 3001; // Используйте другой порт
   ```

3. Обновите URL в клиентской части, если необходимо.

## Проблемы с HTTPS и мобильным приложением

### Сетевые запросы не работают в мобильном приложении

**Проблема**: После установки APK на телефон приложение не может подключиться к серверу.

**Решение**:
1. Убедитесь, что в production используются полные HTTPS URL:
   ```javascript
   // Проверьте файл client/src/lib/queryClient.ts
   function getBaseApiUrl(): string {
     if (import.meta.env.PROD) {
       return 'https://ваш-проект.replit.app';
     }
     return '';
   }
   ```

2. Убедитесь, что capacitor.config.ts настроен правильно:
   ```typescript
   server: {
     url: `https://${replitDomain}`,
     androidScheme: 'https'
   }
   ```

### Ошибка "cleartext traffic not permitted"

**Проблема**: В Android приложении возникает ошибка безопасности при попытке загрузить HTTP-контент.

**Решение**:
1. Убедитесь, что все URL в приложении используют HTTPS, а не HTTP
2. Проверьте настройки в capacitor.config.ts:
   ```typescript
   android: {
     allowMixedContent: false
   }
   ```
3. При необходимости, можно временно разрешить HTTP для отладки:
   ```typescript
   android: {
     allowMixedContent: true // только для отладки!
   }
   ```

### Невозможно зарегистрировать push-уведомления в Android

**Проблема**: Push-уведомления не регистрируются в Android.

**Решение**:
1. Проверьте, что в Firebase правильно настроен проект
2. Убедитесь, что URL для регистрации push-уведомлений использует HTTPS
3. В Android-приложении проверьте конфигурацию:
   ```typescript
   plugins: {
     OneSignal: {
       notificationURLOpenDeeplink: true
     }
   }
   ```

## Дополнительная информация

### Тестирование HTTPS в Replit

Чтобы убедиться, что ваше приложение корректно работает с HTTPS, вы можете:

1. Задеплоить приложение в Replit (кнопка "Run" создаст публичный URL)
2. Проверить доступность по HTTPS: `https://ваш-проект.replit.app`
3. Проверить, что все API-запросы выполняются через HTTPS

### Тестирование мобильного приложения

Перед установкой APK на реальное устройство рекомендуется:

1. Проверить настройки capacitor.config.ts
2. Убедиться, что все API-запросы используют полные HTTPS URL
3. Проверить работу push-уведомлений на веб-версии

Если возникают другие проблемы, не описанные в этом руководстве, пожалуйста, создайте обращение с подробным описанием проблемы и шагами для ее воспроизведения.