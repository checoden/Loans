#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
log() {
  echo -e "${GREEN}[BUILD]${NC} $1"
}

error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
build_and_run() {
  log "–ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
  
  # –®–∞–≥ 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  log "–®–∞–≥ 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
  if ! npm run build; then
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
  fi
  
  # –®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ APK
  log "–®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è APK..."
  if ! node prepare-for-apk.js; then
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ —Ñ–∞–π–ª–æ–≤ –¥–ª—è APK"
    exit 1
  fi
  
  # –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
  log "–®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
  npm run dev &
  WEB_SERVER_PID=$!
  
  # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ push-—Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
  if [ -f "run-push-server.js" ]; then
    log "–®–∞–≥ 4: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π..."
    node run-push-server.js &
    PUSH_SERVER_PID=$!
  fi
  
  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (Ctrl+C)
  log "–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã! üöÄ"
  log "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000"
  
  if [ -n "$PUSH_SERVER_PID" ]; then
    info "Push-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å PID: $PUSH_SERVER_PID"
  fi
  
  info "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
  
  # –û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  trap cleanup INT TERM
  wait $WEB_SERVER_PID
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
  log "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..."
  
  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
  if [ -n "$WEB_SERVER_PID" ]; then
    log "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (PID: $WEB_SERVER_PID)..."
    kill $WEB_SERVER_PID 2>/dev/null
  fi
  
  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ push-—Å–µ—Ä–≤–µ—Ä–∞
  if [ -n "$PUSH_SERVER_PID" ]; then
    log "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ push-—Å–µ—Ä–≤–µ—Ä–∞ (PID: $PUSH_SERVER_PID)..."
    kill $PUSH_SERVER_PID 2>/dev/null
  fi
  
  log "–í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
  exit 0
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
build_and_run