# Настройка Push-уведомлений для Android 13+

## Проблема
Начиная с Android 13 (API level 33), Google изменил требования к push-уведомлениям:
- Разрешение `POST_NOTIFICATIONS` должно запрашиваться во время выполнения
- Простое объявление в манифесте недостаточно
- Пользователь должен явно разрешить уведомления

## Решение
Мы используем комбинацию `@capacitor/push-notifications` и `OneSignal`:

### 1. Capacitor Push Notifications
Отвечает за:
- Запрос разрешения POST_NOTIFICATIONS во время выполнения
- Регистрацию устройства для получения push-токена
- Обработку системных событий уведомлений

### 2. OneSignal
Отвечает за:
- Отправку уведомлений
- Аналитику
- Управление кампаниями

## Как это работает

### В коде (`client/src/lib/onesignal.ts`):
```typescript
// 1. Сначала запрашиваем разрешение через Capacitor
const result = await PushNotifications.requestPermissions();

// 2. Если разрешение получено, регистрируемся
if (result.receive === 'granted') {
  await PushNotifications.register();
}

// 3. Затем инициализируем OneSignal
initializeMobileOneSignal(environment);
```

### В манифесте (`AndroidManifest.xml`):
```xml
<!-- Объявляем разрешение -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

## Процесс сборки APK
CI/CD автоматически:
1. Устанавливает `@capacitor/push-notifications`
2. Добавляет разрешения в манифест
3. Синхронизирует изменения с Android проектом
4. Проверяет наличие всех необходимых разрешений

## Проверка работы
После установки APK на Android 13+:
1. При первом запуске появится системный диалог запроса разрешений
2. В логах консоли будут сообщения о статусе разрешений
3. Устройство автоматически зарегистрируется в OneSignal

## Важные моменты
- Разрешение нужно запрашивать при каждом запуске приложения
- Пользователь может отозвать разрешение в настройках системы
- Без разрешения push-уведомления работать не будут