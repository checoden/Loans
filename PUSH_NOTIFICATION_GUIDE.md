# Руководство по настройке и использованию Push-уведомлений

Данное руководство поможет настроить и использовать push-уведомления в приложении "Займы онлайн" как на веб-платформе, так и в мобильной версии приложения.

## Содержание

1. [Общая информация](#общая-информация)
2. [Настройка для Web](#настройка-для-web)
3. [Настройка для мобильного приложения](#настройка-для-мобильного-приложения)
4. [Сборка APK через GitHub Actions](#сборка-apk-через-github-actions)
5. [Отправка уведомлений](#отправка-уведомлений)
6. [Решение проблем](#решение-проблем)

## Общая информация

В проекте используется сервис OneSignal для отправки push-уведомлений. Он позволяет отправлять уведомления как на веб-платформу, так и на мобильные устройства (Android).

### Ключи OneSignal

В проекте используются следующие ключи OneSignal:

- `VITE_ONESIGNAL_APP_ID`: a3060406-47e5-4331-91b3-296c3cbdcb86
- `VITE_ONESIGNAL_REST_API_KEY` - ключ REST API для отправки уведомлений

## Настройка для Web

### 1. Проверка наличия ключей

Убедитесь, что в переменных окружения установлены `VITE_ONESIGNAL_APP_ID` и `VITE_ONESIGNAL_REST_API_KEY`.

### 2. Инициализация OneSignal

OneSignal автоматически инициализируется при загрузке страницы. Код инициализации находится в файле `client/src/lib/onesignal.ts`. Для веб-версии используется стандартный JavaScript SDK OneSignal с адаптацией для работы с мобильным приложением.

### 3. Тестирование подписки

При первом посещении сайта, пользователю будет предложено подписаться на уведомления. В веб-версии в правом нижнем углу отображается кнопка управления уведомлениями.

## Настройка для мобильного приложения

### Подготовка Firebase и OneSignal

1. Создайте проект в [Firebase Console](https://console.firebase.google.com/)
2. Добавьте приложение Android с ID пакета `ru.checoden.onlineloans` 
3. Скачайте файл `google-services.json`
4. Поместите файл в папку `capacitor-app/` (не в корень проекта!)
5. В OneSignal Dashboard откройте настройки проекта и подключите Firebase, добавив Server Key из Firebase

### Подготовка локальной копии проекта

1. Запустите скрипт подготовки проекта:

```bash
node prepare-for-apk.js
```

2. Настройте канал уведомлений и проверьте правильность идентификатора пакета:

```bash
node setup-android-notification-channel.js
```

Этот скрипт:
- Проверяет и исправляет идентификатор пакета в build.gradle (applicationId)
- Проверяет и исправляет идентификатор пакета в AndroidManifest.xml (package)
- Добавляет код для создания канала уведомлений "займы-онлайн-уведомления" в MainActivity.java

3. Зафиксируйте изменения в Git:

```bash
git add .
git commit -m "Настроены push-уведомления для Android"
git push
```

## Сборка APK через GitHub Actions

### Автоматическая сборка

1. Создайте тег версии в формате `v*` (например, `v1.0.0`):

```bash
git tag v1.0.0
git push origin v1.0.0
```

2. GitHub Actions workflow автоматически запустится и выполнит:
   - Подготовку проекта через `prepare-for-apk.js`
   - Настройку канала уведомлений через `setup-android-notification-channel.js`
   - Копирование `google-services.json` в нужную директорию
   - Сборку APK с поддержкой push-уведомлений

3. После успешной сборки:
   - Скачайте APK из вкладки Actions репозитория
   - Файл будет называться `Loans-v1.0.0.apk` (в соответствии с версией тега)

### Настройка Workflow

Настройка GitHub Actions workflow для сборки APK находится в файле `.github/workflows/android.yml`. Основные компоненты:

1. Подготовка проекта для сборки
2. Сборка APK с использованием Capacitor
3. Подписывание APK для публикации
4. Сохранение APK как артефакт сборки

## Отправка уведомлений

### Административная панель

Для отправки уведомлений используйте панель администратора:

1. Войдите в систему с учетными данными администратора (login: admin, password: admin123)
2. Перейдите на страницу "Push-уведомления"
3. Заполните форму:
   - Заголовок уведомления
   - Текст уведомления
   - URL (необязательно)
4. Нажмите "Отправить уведомление"

### Программная отправка

Для программной отправки используйте функцию `sendPushNotification` из файла `client/src/lib/onesignal.ts`:

```typescript
import { sendPushNotification } from '@/lib/onesignal';

// Пример использования
async function notifyAboutNewOffer() {
  try {
    await sendPushNotification(
      'Новое предложение', 
      'У нас появился новый займ с процентной ставкой 0%!',
      'https://example.com/offers/new'
    );
  } catch (error) {
    console.error('Ошибка при отправке уведомления:', error);
  }
}
```

## Решение проблем

### Web-платформа

**Проблема**: Уведомления не отображаются в браузере
**Решение**: 
1. Проверьте, что пользователь дал разрешение на уведомления в браузере
2. Убедитесь, что в консоли нет ошибок при инициализации OneSignal
3. Проверьте доступность URL `https://cdn.onesignal.com/sdks/OneSignalSDK.js`

### Android-приложение

**Проблема**: Уведомления не приходят на Android
**Решение**:
1. Проверьте файл `google-services.json`:
   - Он должен содержать `"package_name": "ru.checoden.onlineloans"`
   - Должен быть действительным файлом от Firebase для вашего проекта
2. Проверьте настройки OneSignal Dashboard:
   - FCM должен быть настроен с правильным API-ключом
   - Канал уведомлений "займы-онлайн-уведомления" должен быть создан
3. Проверьте APK:
   - Используйте последнюю версию, собранную через GitHub Actions
   - Установите APK на устройство и разрешите уведомления в настройках приложения

**Проблема**: Ошибки при сборке APK через GitHub Actions
**Решение**:
1. Проверьте файл `.github/workflows/android.yml`
2. Убедитесь, что секреты для подписи APK настроены в репозитории GitHub
3. Проверьте наличие `google-services.json` в репозитории
4. Проверьте логи сборки в GitHub Actions

### Общие проблемы

**Проблема**: Ошибка "Invalid App ID" при отправке
**Решение**: 
- Проверьте, что установлен правильный `VITE_ONESIGNAL_APP_ID`: a3060406-47e5-4331-91b3-296c3cbdcb86
- Убедитесь, что проект активен в OneSignal Dashboard

**Проблема**: Ошибка "Invalid API Key" при отправке
**Решение**: 
- Проверьте, что `VITE_ONESIGNAL_REST_API_KEY` правильно установлен
- Обновите ключ в настройках OneSignal, если необходимо

## Полезные ссылки

- [Документация OneSignal для Capacitor](https://documentation.onesignal.com/docs/ionic-capacitor-cordova-sdk-setup)
- [OneSignal Dashboard](https://app.onesignal.com/login)
- [Firebase Console](https://console.firebase.google.com/)
- [Репозиторий проекта](https://github.com/checoden/onlineloans)
- [Опубликованная веб-версия](https://onlineloans.replit.app/)