# Руководство по настройке и использованию push-уведомлений

Эта документация описывает, как настроить и использовать систему push-уведомлений в вашем приложении "Займы онлайн".

## Содержание

1. [Архитектура системы уведомлений](#архитектура-системы-уведомлений)
2. [Настройка OneSignal](#настройка-onesignal)
3. [Интеграция в мобильное приложение](#интеграция-в-мобильное-приложение)
4. [Отправка уведомлений из админ-панели](#отправка-уведомлений-из-админ-панели)
5. [Структура проекта](#структура-проекта)
6. [Диагностика проблем](#диагностика-проблем)

## Архитектура системы уведомлений

Система push-уведомлений построена на следующих компонентах:

1. **OneSignal SDK** — JavaScript-библиотека, которая инициализируется на стороне клиента и регистрирует устройство для получения уведомлений.
2. **OneSignal REST API** — API, которое используется для отправки уведомлений на зарегистрированные устройства.
3. **Админ-панель** — интерфейс для составления и отправки уведомлений.
4. **Backend API** — серверная часть, которая обрабатывает запросы от админ-панели и передаёт их в OneSignal API.

## Настройка OneSignal

### 1. Создание аккаунта OneSignal

1. Зарегистрируйтесь на [onesignal.com](https://onesignal.com)
2. Создайте новое приложение в консоли OneSignal
3. Выберите платформы, которые вы будете поддерживать (Web, Android, iOS)

### 2. Настройка для Web

1. В консоли OneSignal перейдите в раздел настройки вашего приложения
2. Выберите "Web Push" в разделе платформ
3. Следуйте инструкциям для настройки GCM/FCM (для Chrome) и добавления Service Worker
4. Скопируйте ваш App ID и REST API Key

### 3. Настройка для Android (если планируете скомпилировать APK)

1. В консоли OneSignal выберите "Android" в разделе платформ
2. Создайте проект в Firebase Console и получите google-services.json
3. Настройте Firebase Cloud Messaging (FCM)
4. Скопируйте ваш FCM Server Key в настройки OneSignal

### 4. Настройка для iOS (если планируете скомпилировать для iOS)

1. В консоли OneSignal выберите "iOS" в разделе платформ
2. Создайте Apple Push Notification Service (APNs) certificate или key
3. Загрузите сертификат или ключ в OneSignal

### 5. Добавление ключей в переменные окружения

Добавьте следующие ключи в переменные окружения Replit:

```
VITE_ONESIGNAL_APP_ID=ваш_app_id
VITE_ONESIGNAL_REST_API_KEY=ваш_rest_api_key
```

## Интеграция в мобильное приложение

### Для компиляции в APK с помощью Capacitor

1. Убедитесь, что у вас установлены необходимые зависимости:
   ```
   npm install @capacitor/cli @capacitor/core
   ```

2. Инициализируйте Capacitor в проекте (уже сделано):
   ```
   npx cap init
   ```

3. Подготовьте проект для сборки, используя скрипт:
   ```
   node prepare-for-apk.js
   ```

4. Настройте Firebase для Android:
   - Скопируйте файл `google-services.json` от Firebase в каталог `android/app/`

5. Сборка и запуск:
   ```
   npx cap add android
   npx cap open android
   ```
   
   Затем используйте Android Studio для сборки APK.

## Отправка уведомлений из админ-панели

1. Авторизуйтесь в админ-панели (`/admin/login`) с учетными данными:
   - Логин: `admin`
   - Пароль: `admin123`

2. Перейдите в раздел "Push-уведомления" на панели администратора.

3. Заполните форму отправки уведомления:
   - **Заголовок** — будет отображаться как название уведомления
   - **Текст** — основной текст уведомления
   - **URL** (необязательно) — ссылка, по которой будет совершен переход при нажатии на уведомление

4. Нажмите кнопку "Отправить уведомление".

## Структура проекта

Файлы, отвечающие за работу push-уведомлений:

- `client/src/lib/onesignal.ts` — клиентская библиотека для инициализации OneSignal
- `client/src/pages/PushNotificationPage.tsx` — страница администратора для отправки уведомлений
- `server/routes.ts` — серверные API-маршруты для обработки запросов
- `push-server.js` — упрощенный сервер для поддержки уведомлений в APK-версии
- `index.js` — основной серверный файл с поддержкой уведомлений

## Диагностика проблем

### Web-версия не получает уведомления

1. Проверьте консоль браузера на наличие ошибок
2. Убедитесь, что HTTPS настроен правильно (необходим для Web Push)
3. Проверьте, что service worker правильно зарегистрирован
4. Убедитесь, что ваш браузер поддерживает Push API и не блокирует уведомления

### Мобильная версия не получает уведомления

1. Проверьте настройки Firebase (для Android) или APNs (для iOS)
2. Убедитесь, что приложение имеет разрешения на отправку уведомлений
3. Проверьте интеграцию OneSignal SDK в мобильном приложении
4. Посмотрите логи в консоли OneSignal, чтобы увидеть, отправляются ли уведомления

### Ошибки при отправке уведомлений из админ-панели

1. Проверьте правильность указанных API-ключей
2. Убедитесь, что есть подключение к интернету
3. Проверьте ответ от OneSignal API в консоли администратора
4. Убедитесь, что у вас есть хотя бы одно зарегистрированное устройство для получения уведомлений

Если проблемы сохраняются, обратитесь к документации OneSignal или запросите поддержку.