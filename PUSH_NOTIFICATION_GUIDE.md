# Руководство по настройке и использованию Push-уведомлений

Данное руководство поможет настроить и использовать push-уведомления в приложении "Займы онлайн" как на веб-платформе, так и в мобильной версии приложения.

## Содержание

1. [Общая информация](#общая-информация)
2. [Настройка для Web](#настройка-для-web)
3. [Настройка для мобильного приложения](#настройка-для-мобильного-приложения)
4. [Отправка уведомлений](#отправка-уведомлений)
5. [Решение проблем](#решение-проблем)

## Общая информация

В проекте используется сервис OneSignal для отправки push-уведомлений. Он позволяет отправлять уведомления как на веб-платформу, так и на мобильные устройства (Android и iOS).

### Ключи OneSignal

В проекте используются следующие ключи OneSignal:

- `VITE_ONESIGNAL_APP_ID` - идентификатор приложения в OneSignal
- `VITE_ONESIGNAL_REST_API_KEY` - ключ REST API для отправки уведомлений

## Настройка для Web

### 1. Проверка наличия ключей

Убедитесь, что в переменных окружения установлены `VITE_ONESIGNAL_APP_ID` и `VITE_ONESIGNAL_REST_API_KEY`.

### 2. Инициализация OneSignal

OneSignal автоматически инициализируется при загрузке страницы. Код инициализации находится в файле `client/src/lib/onesignal.ts`.

### 3. Тестирование подписки

При первом посещении сайта, пользователю будет предложено подписаться на уведомления. Убедитесь, что в правом нижнем углу есть кнопка управления уведомлениями.

## Настройка для мобильного приложения

### Подготовка Android приложения

1. Запустите скрипт подготовки проекта:

```bash
node prepare-for-apk.js
```

2. Убедитесь, что у вас есть файл `google-services.json` от Firebase для интеграции с FCM (Firebase Cloud Messaging).

3. Создайте APK:

```bash
./build-apk.sh
```

### Интеграция с Firebase

Для работы push-уведомлений на Android требуется интеграция с Firebase:

1. Создайте проект в [Firebase Console](https://console.firebase.google.com/)
2. Добавьте приложение Android с ID пакета `ru.yourcompany.microloans`
3. Скачайте файл `google-services.json`
4. Поместите файл в корень проекта Android

### Настройка iOS-приложения

Для iOS требуется настройка APNs (Apple Push Notification service):

1. Создайте сертификат push-уведомлений в Apple Developer Console
2. Загрузите этот сертификат в OneSignal Dashboard
3. Подробнее в [документации OneSignal для iOS](https://documentation.onesignal.com/docs/ios-sdk-setup)

## Отправка уведомлений

### Административная панель

Для отправки уведомлений используйте панель администратора:

1. Войдите в систему с учетными данными администратора
2. Перейдите на страницу "Push-уведомления"
3. Заполните форму:
   - Заголовок уведомления
   - Текст уведомления
   - URL (необязательно)
4. Нажмите "Отправить уведомление"

### Программная отправка

Для программной отправки используйте функцию `sendPushNotification` из файла `client/src/lib/onesignal.ts`:

```typescript
import { sendPushNotification } from '@/lib/onesignal';

// Пример использования
async function notifyAboutNewOffer() {
  try {
    await sendPushNotification(
      'Новое предложение', 
      'У нас появился новый займ с процентной ставкой 0%!',
      'https://example.com/offers/new'
    );
  } catch (error) {
    console.error('Ошибка при отправке уведомления:', error);
  }
}
```

## Решение проблем

### Web-платформа

**Проблема**: Уведомления не отображаются в браузере
**Решение**: 
1. Проверьте, что пользователь дал разрешение на уведомления
2. Убедитесь, что в консоли нет ошибок при инициализации OneSignal
3. Проверьте доступность URL `https://cdn.onesignal.com/sdks/OneSignalSDK.js`

### Мобильное приложение

**Проблема**: Уведомления не приходят на Android
**Решение**:
1. Проверьте, что файл `google-services.json` правильно настроен
2. Убедитесь, что FCM настроен в OneSignal Dashboard
3. Проверьте наличие разрешения на уведомления в настройках приложения

**Проблема**: Уведомления не приходят на iOS
**Решение**:
1. Проверьте, что сертификат APNs загружен в OneSignal
2. Убедитесь, что пользователь дал разрешение на уведомления
3. Проверьте настройки background modes в Xcode

### Общие проблемы

**Проблема**: Ошибка "Invalid App ID" при отправке
**Решение**: Проверьте, что `VITE_ONESIGNAL_APP_ID` правильно установлен

**Проблема**: Ошибка "Invalid API Key" при отправке
**Решение**: Проверьте, что `VITE_ONESIGNAL_REST_API_KEY` правильно установлен

## Полезные ссылки

- [Документация OneSignal](https://documentation.onesignal.com/docs)
- [OneSignal Dashboard](https://app.onesignal.com/login)
- [Firebase Console](https://console.firebase.google.com/)
- [Apple Developer Console](https://developer.apple.com/account/)