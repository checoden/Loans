name: Build-APK-New          # Новый обновленный workflow

on:
  push:
    tags: ['v*']         # триггер только при push тега v1.0.0, v1.1.3 …

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Клонируем репозиторий
    - uses: actions/checkout@v4

    # 2. Node.js + зависимости фронта/бэка
    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. JDK 17 (совместимый с Gradle 8.0.2)
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - run: npm ci
    
    # Подготовка проекта для APK
    - name: Prepare for APK
      run: |
        # Проверяем версию Java
        echo "Using Java version:"
        java -version
        
        node prepare-for-apk.js
        cd capacitor-app
        
        # Используем npm install вместо npm ci, если нет package-lock.json
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        
        npx cap add android
        cd ..
        
        # Исправляем версию Gradle для совместимости с Java 17
        node fix-gradle-version.js
        
        cd capacitor-app
        npx cap sync android
        cd ..
        node setup-android-notification-channel.js

    # 4. Android‑SDK + build‑tools
    - uses: android-actions/setup-android@v3

    # 5. Дополнительная настройка Gradle (записываем явно опции Java 17)
    - name: Configure Gradle
      run: |
        cd capacitor-app/android
        
        # Более детальный вывод для отладки
        cat gradle/wrapper/gradle-wrapper.properties
        
        # Если build.gradle существует, модифицируем его для поддержки Java 17
        if [ -f build.gradle ]; then
          echo "Updating build.gradle for Java 17 support..."
          echo "
// Add to bottom of build.gradle 
allprojects {
    tasks.withType(JavaCompile) {
        options.compilerArgs << '-Xlint:unchecked' << '-Xlint:deprecation'
    }
    
    afterEvaluate { project ->
        if (project.hasProperty('android')) {
            project.android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }
            }
        }
    }
}" >> build.gradle
        fi
        
        # Проверяем структуру проекта для отладки
        ls -la
        echo "Showing project files for debugging:"
        find . -type f -name "*.gradle" | xargs ls -la
        cd ../..

    # 6. Release‑сборка (unsigned)
    - name: Build unsigned APK
      run: |
        # Копируем google-services.json в правильную директорию
        if [ -f "capacitor-app/google-services.json" ]; then
          echo "Copying google-services.json to Android project"
          cp capacitor-app/google-services.json capacitor-app/android/app/google-services.json
        else
          echo "WARNING: google-services.json not found in capacitor-app directory!"
        fi
        
        cd capacitor-app/android
        ./gradlew assembleRelease

    # 7. Восстанавливаем keystore из секрета
    - name: Decode keystore
      run: echo "$KEYSTORE_B64" | base64 -d > keystore.jks
      env:
        KEYSTORE_B64: ${{ secrets.KEYSTORE_B64 }}

    # 8. Подписываем и apksigner (динамический поиск APK)
    - name: Sign APK (apksigner)
      run: |
        # 1. Находим первый release‑unsigned.apk
        UNSIGNED=$(find capacitor-app/android/app/build/outputs/apk/release -name '*release-unsigned.apk' | head -n 1)
        echo "Unsigned: $UNSIGNED"

        # 2. Копируем во временный файл, т.к. apksigner пишeт поверх
        cp "$UNSIGNED" app-unsigned.apk

        # 3. Подписываем V1+V2
        APKSIGNER="$ANDROID_HOME/build-tools/34.0.0/apksigner"
        $APKSIGNER sign \
          --ks keystore.jks \
          --ks-key-alias "$ALIAS" \
          --ks-pass pass:"$KS_PASS" \
          --key-pass pass:"$KEY_PASS" \
          --out Loans-${{ github.ref_name }}.apk \
          app-unsigned.apk

        # 4. Проверяем сигнатуру
        $APKSIGNER verify --verbose Loans-${{ github.ref_name }}.apk
      env:
        KS_PASS:  ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASS: ${{ secrets.KEY_PASSWORD }}
        ALIAS:    ${{ secrets.KEY_ALIAS }}

    # 9. Публикуем артефакт
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: Loans-*.apk