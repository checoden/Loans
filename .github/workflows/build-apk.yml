name: Build APK

on:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - uses: actions/checkout@v4

    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java 21 (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Capacitor 7.2.0)
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    # 3.1 –û—á–∏—â–∞–µ–º –∫—ç—à Gradle, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
    - name: Clear Gradle cache
      run: |
        rm -rf /home/runner/.gradle || true
        rm -rf ~/.gradle/wrapper/dists || true
        echo "–ö—ç—à Gradle –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω"

    # 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - run: npm ci

    # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è OneSignal
    - name: Setup OneSignal Environment
      run: |
        echo "VITE_ONESIGNAL_APP_ID=${{ secrets.ONESIGNAL_APP_ID }}" >> $GITHUB_ENV
        echo "VITE_ONESIGNAL_REST_API_KEY=${{ secrets.ONESIGNAL_REST_API_KEY }}" >> $GITHUB_ENV
        echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è OneSignal —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # 6. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Capacitor
    - name: Prepare Capacitor project
      run: |
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ - —Å–æ–∑–¥–∞–µ—Ç –ø–∞–ø–∫—É capacitor-app —Å –Ω—É–∂–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
        node prepare-for-apk.js
        
        cd capacitor-app
        
        # –û—á–∏—â–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Capacitor
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Capacitor..."
        npm install
        
        # –û—á–∏—â–∞–µ–º –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        echo "–£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å"
        rm -rf android
        
        # –û—á–∏—â–∞–µ–º package.json –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Capacitor –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        echo "–û—á–∏—â–∞–µ–º package.json –æ—Ç Capacitor –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        jq 'del(.dependencies."@capacitor/android") | del(.dependencies."@capacitor/core")' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        npm install
        
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è Gradle Wrapper
        mkdir -p android/gradle/wrapper
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Capacitor
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π Capacitor"
        npm install @capacitor/core@7.2.0 @capacitor/android@7.2.0 --legacy-peer-deps

    # 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    - name: Add Android platform
      run: |
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º keystore –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ
        mkdir -p capacitor-app/android/app
        echo "${{ secrets.KEYSTORE_B64 }}" | base64 -d > capacitor-app/android/app/android-keystore.keystore
        echo "Keystore —Å–æ–∑–¥–∞–Ω –≤ capacitor-app/android/app/android-keystore.keystore"
        ls -la capacitor-app/android/app/android-keystore.keystore
        
        cd capacitor-app
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ keystore
        if [ -f "android/app/android-keystore.keystore" ]; then
          echo "‚úÖ –§–∞–π–ª keystore —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ $(pwd)/android/app/android-keystore.keystore"
          ls -la android/app/android-keystore.keystore
        else
          echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª keystore –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        echo "–î–æ–±–∞–≤–ª—è–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É..."
        npx cap add android || { 
          echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –ø—ã—Ç–∞–µ–º—Å—è –≥–ª—É–±–æ–∫–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"; 
          rm -rf android node_modules;
          npm install;
          npm install @capacitor/core@7.2.0 @capacitor/android@7.2.0 onesignal-cordova-plugin@5.2.13;
          npx cap add android; 
        }
        
        # –ö–æ–ø–∏—Ä—É–µ–º google-services.json –≤ –Ω—É–∂–Ω—ã–µ –º–µ—Å—Ç–∞
        if [ -f "../google-services.json" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º google-services.json –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p android/app
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é android/app –¥–ª—è Firebase –ø–ª–∞–≥–∏–Ω–∞
          cp ../google-services.json android/app/google-services.json
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–æ—Ä–µ–Ω—å android –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          cp ../google-services.json android/google-services.json
          
          echo "–§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ android/app:"
          ls -la android/app/google-services.json || echo "–§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù –í android/app!"
        elif [ -f "google-services.json" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º google-services.json –∏–∑ capacitor-app –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p android/app
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é android/app –¥–ª—è Firebase –ø–ª–∞–≥–∏–Ω–∞
          cp google-services.json android/app/google-services.json
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–æ—Ä–µ–Ω—å android –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          cp google-services.json android/google-services.json
          
          echo "–§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ android/app:"
          ls -la android/app/google-services.json || echo "–§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù –í android/app!"
        else
          echo "–í–ù–ò–ú–ê–ù–ò–ï: google-services.json –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∏ –≤ capacitor-app!"
          echo "Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞!"
        fi
        
        # –í—Ä—É—á–Ω—É—é –∫–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω AndroidManifest —Å POST_NOTIFICATIONS
        if [ -f "../capacitor-app/android/app/src/main/AndroidManifest-template.xml" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º AndroidManifest-template.xml —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º POST_NOTIFICATIONS..."
          cp ../capacitor-app/android/app/src/main/AndroidManifest-template.xml android/app/src/main/AndroidManifest.xml
          echo "‚úÖ AndroidManifest –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º POST_NOTIFICATIONS"
        fi
        
        cd ..
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ü–ï–†–ï–î —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π Android
        echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è Android..."
        node setup-android-notification-channel.js
        
        cd capacitor-app
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç —Å Android –ü–û–°–õ–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        echo "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Android –ø—Ä–æ–µ–∫—Ç–∞..."
        npx cap sync android
        
        # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª—ã –¥–ª—è Android
        echo "–°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª—ã –¥–ª—è Android..."
        chmod +x ./create-directories.sh
        ./create-directories.sh
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS –≤ AndroidManifest.xml –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS..."
        chmod +x ./add-notification-permission.sh
        ./add-notification-permission.sh
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –≤ build.gradle
        echo "–û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–±–æ—Ä–∫–∏..."
        node update-gradle-signing.js
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é Android Gradle Plugin –¥–æ 8.9
        echo "–û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é Android Gradle Plugin –¥–æ 8.9..."
        node update-android-plugin.js
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Gradle –≤ Wrapper
        echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è Gradle Wrapper:"
        cat android/gradle/wrapper/gradle-wrapper.properties

    # 8. Android SDK –∏ Gradle setup
    - uses: android-actions/setup-android@v3
    - uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5
        build-cache-enabled: true

    # 10. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–±–æ—Ä–∫–µ APK –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏
    - name: Prepare APK signing
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd capacitor-app
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ keystore –∏ –µ–≥–æ —Ä–∞–∑–º–µ—Ä
        # –°–æ–∑–¥–∞–µ–º keystore –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ
        echo "‚ùå –°–æ–∑–¥–∞–µ–º keystore –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
        mkdir -p android/app
        echo "${{ secrets.KEYSTORE_B64 }}" | base64 -d > android/app/android-keystore.keystore
        ls -la android/app/android-keystore.keystore
        
        cd android
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ keystore (—Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –ø–∞–ø–∫–∏ app)
        KEYSTORE_PATH="android-keystore.keystore"
        echo "–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ keystore: $KEYSTORE_PATH"
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–ø–∏—Å–∏
        cd app
        chmod +x ../../../add-signing-config.sh
        ../../../add-signing-config.sh
        cd ..
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–æ—Å—å –≤ build.gradle
        echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ build.gradle –ø–æ—Å–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ ==="
        cat app/build.gradle | grep -A 20 -B 5 signingConfigs || echo "signingConfigs –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        echo "==============================================="
        
        # –û—Ç–ª–∞–¥–∫–∞ –ø—É—Ç–∏ –∫ keystore
        echo "=== –û—Ç–ª–∞–¥–∫–∞ –ø—É—Ç–∏ –∫ keystore ==="
        ls -l app | grep keystore || true
        ls -l . | grep keystore || true
        echo "============================="
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏
        echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
        
    # 10.1 –°–±–æ—Ä–∫–∞ APK —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–ø–∏—Å–∏
    - name: Build APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd capacitor-app/android
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ keystore —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º keystore —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
        if [ -f "app/android-keystore.keystore" ]; then
          echo "‚úÖ Keystore –Ω–∞–π–¥–µ–Ω –≤ app/android-keystore.keystore"
          ls -la app/android-keystore.keystore
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: Keystore –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ app/android-keystore.keystore"
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ app/:"
          ls -la app/
          exit 1
        fi
        
        # –°–æ–±–∏—Ä–∞–µ–º APK —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–ø–∏—Å–∏
        ./gradlew :app:assembleRelease --stacktrace

    # 11. –ù–∞—Ö–æ–¥–∏–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π APK
    - name: Find and rename APK
      run: |
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏ ==="
        cd capacitor-app/android
        find app/build -type f -name "*.apk" -o -name "*.aab" | xargs -I{} ls -la "{}"
        
        # –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π APK - —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ
        echo "–ò—â–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Ä–µ–ª–∏–∑–Ω—ã–µ APK —Ñ–∞–π–ª—ã..."
        APK_FILES=$(find app/build/outputs/apk/release -name "*.apk" | grep -v unsigned || true)
        
        if [ -z "$APK_FILES" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ APK —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –ø—É—Ç–∏..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—É—Ç–∏
          APK_FILES=$(find app/build -path "*/release/*.apk" | head -n 1 || true)
          
          if [ -z "$APK_FILES" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ä–µ–ª–∏–∑–Ω—ã–µ APK. –ò—â–µ–º –õ–Æ–ë–´–ï APK —Ñ–∞–π–ª—ã..."
            APK_FILES=$(find app/build -name "*.apk" || true)
            
            if [ -z "$APK_FILES" ]; then
              echo "‚ùå APK —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤–æ–æ–±—â–µ! –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏:"
              find app/build -type d | sort
              exit 1
            fi
          fi
        fi
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ APK —Ñ–∞–π–ª—ã:"
        echo "$APK_FILES" | xargs -I{} ls -la "{}"
        
        # –ö–æ–ø–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π APK –≤ –∫–æ—Ä–µ–Ω—å —Å –Ω—É–∂–Ω—ã–º –∏–º–µ–Ω–µ–º
        FIRST_APK=$(echo "$APK_FILES" | head -n 1)
        cp "$FIRST_APK" "../../Loans-${{ github.ref_name }}.apk"
        
        cd ../../
        echo "‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π APK: Loans-${{ github.ref_name }}.apk"
        ls -la "Loans-${{ github.ref_name }}.apk"
      
    # 11.1 –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SHA1 –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è Firebase)
    - name: Display certificate fingerprint
      run: |
        echo "–û—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (SHA1) –¥–ª—è Firebase:"
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ keystore –≤ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        if [ -f "capacitor-app/android/app/android-keystore.keystore" ]; then
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º keystore –∏–∑ capacitor-app/android/app/"
          keytool -list -v -keystore capacitor-app/android/app/android-keystore.keystore -alias "${{ secrets.KEY_ALIAS }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep SHA1
        elif [ -f "keystore.jks" ]; then
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º keystore –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
          keytool -list -v -keystore keystore.jks -alias "${{ secrets.KEY_ALIAS }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep SHA1
        else
          echo "‚ùå Keystore –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ø–µ—á–∞—Ç–∫–∞"
          find . -name "*.keystore" -o -name "*.jks" | xargs -I{} echo "–ù–∞–π–¥–µ–Ω keystore: {}"
        fi

    # –≠—Ç–æ—Ç —à–∞–≥ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å —Ä–µ–ª–∏–∑–Ω—ã–π APK –∏–∑ —à–∞–≥–∞ 11
    # –û—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    - name: Verify APK file
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ APK —Ñ–∞–π–ª–∞:"
        if [ -f "Loans-${{ github.ref_name }}.apk" ]; then
          echo "‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π APK –Ω–∞–π–¥–µ–Ω: Loans-${{ github.ref_name }}.apk"
          ls -la "Loans-${{ github.ref_name }}.apk"
        else
          echo "‚ùå –ò—Ç–æ–≥–æ–≤—ã–π APK –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi

    # 12. –ü—É–±–ª–∏–∫—É–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: Loans-*.apk
        
    # 13. –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ GitHub Release —Å APK
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Loans-*.apk
        draft: false
        prerelease: false
        name: "–ó–∞–π–º—ã –æ–Ω–ª–∞–π–Ω ${{ github.ref_name }}"
        body: |
          ### –ó–∞–π–º—ã –æ–Ω–ª–∞–π–Ω (–≤–µ—Ä—Å–∏—è ${{ github.ref_name }})
          
          **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
          - –ë—Ä–∞—É–∑–µ—Ä –∑–∞–π–º–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
          - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–π–º–∞–º–∏
          - Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ OneSignal
          
          **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
          - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Capacitor –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤ APK
          - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Firebase –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}