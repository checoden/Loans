name: Build APK

on:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - uses: actions/checkout@v4

    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java 21 (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Capacitor 7.2.0)
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    # 3.1 –û—á–∏—â–∞–µ–º –∫—ç—à Gradle, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
    - name: Clear Gradle cache
      run: |
        rm -rf /home/runner/.gradle || true
        rm -rf ~/.gradle/wrapper/dists || true
        echo "–ö—ç—à Gradle –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω"

    # 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - run: npm ci

    # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è OneSignal
    - name: Setup OneSignal Environment
      run: |
        echo "VITE_ONESIGNAL_APP_ID=${{ secrets.ONESIGNAL_APP_ID }}" >> $GITHUB_ENV
        echo "VITE_ONESIGNAL_REST_API_KEY=${{ secrets.ONESIGNAL_REST_API_KEY }}" >> $GITHUB_ENV
        echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è OneSignal —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # 6. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Capacitor
    - name: Prepare Capacitor project
      run: |
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ - —Å–æ–∑–¥–∞–µ—Ç –ø–∞–ø–∫—É capacitor-app —Å –Ω—É–∂–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
        node prepare-for-apk.js
        
        cd capacitor-app
        
        # –û—á–∏—â–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Capacitor
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Capacitor..."
        npm install
        
        # –û—á–∏—â–∞–µ–º –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        echo "–£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å"
        rm -rf android
        
        # –û—á–∏—â–∞–µ–º package.json –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Capacitor –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        echo "–û—á–∏—â–∞–µ–º package.json –æ—Ç Capacitor –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        jq 'del(.dependencies."@capacitor/android") | del(.dependencies."@capacitor/core")' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        npm install
        
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª—ã –¥–ª—è Gradle Wrapper
        mkdir -p android/gradle/wrapper
        
        # –°–æ–∑–¥–∞—ë–º gradle-wrapper.properties —Å Gradle 8.0.2
        echo "distributionBase=GRADLE_USER_HOME" > android/gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> android/gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.0.2-bin.zip" >> android/gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> android/gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> android/gradle/wrapper/gradle-wrapper.properties
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º Gradle Wrapper JAR –Ω–∞–ø—Ä—è–º—É—é
        curl -s -o android/gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.0.2/gradle/wrapper/gradle-wrapper.jar
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ Capacitor
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Capacitor"
        npm install @capacitor/core@7.2.0 @capacitor/android@7.2.0

    # 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    - name: Add Android platform
      run: |
        cd capacitor-app
        
        # –î–æ–±–∞–≤–ª—è–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        echo "–î–æ–±–∞–≤–ª—è–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É..."
        npx cap add android || { 
          echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –ø—ã—Ç–∞–µ–º—Å—è –≥–ª—É–±–æ–∫–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"; 
          rm -rf android node_modules;
          npm install;
          npm install @capacitor/core@7.2.0 @capacitor/android@7.2.0 onesignal-cordova-plugin@5.2.13;
          npx cap add android; 
        }
        
        # –ö–æ–ø–∏—Ä—É–µ–º google-services.json –≤ –Ω—É–∂–Ω—ã–µ –º–µ—Å—Ç–∞
        if [ -f "../google-services.json" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º google-services.json –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p android/app
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é android/app –¥–ª—è Firebase –ø–ª–∞–≥–∏–Ω–∞
          cp ../google-services.json android/app/google-services.json
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–æ—Ä–µ–Ω—å android –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          cp ../google-services.json android/google-services.json
          
          echo "–§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ android/app:"
          ls -la android/app/google-services.json || echo "–§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù –í android/app!"
        elif [ -f "google-services.json" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º google-services.json –∏–∑ capacitor-app –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p android/app
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é android/app –¥–ª—è Firebase –ø–ª–∞–≥–∏–Ω–∞
          cp google-services.json android/app/google-services.json
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–æ—Ä–µ–Ω—å android –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          cp google-services.json android/google-services.json
          
          echo "–§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Android"
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ android/app:"
          ls -la android/app/google-services.json || echo "–§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù –í android/app!"
        else
          echo "–í–ù–ò–ú–ê–ù–ò–ï: google-services.json –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∏ –≤ capacitor-app!"
          echo "Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞!"
        fi
        
        # –í—Ä—É—á–Ω—É—é –∫–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω AndroidManifest —Å POST_NOTIFICATIONS
        if [ -f "../capacitor-app/android/app/src/main/AndroidManifest-template.xml" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º AndroidManifest-template.xml —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º POST_NOTIFICATIONS..."
          cp ../capacitor-app/android/app/src/main/AndroidManifest-template.xml android/app/src/main/AndroidManifest.xml
          echo "‚úÖ AndroidManifest –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º POST_NOTIFICATIONS"
        fi
        
        cd ..
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ü–ï–†–ï–î —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π Android
        echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è Android..."
        node setup-android-notification-channel.js
        
        cd capacitor-app
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç —Å Android –ü–û–°–õ–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        echo "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Android –ø—Ä–æ–µ–∫—Ç–∞..."
        npx cap sync android
        
        # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ç—á –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
        echo "–ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ç—á –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ —Å POST_NOTIFICATIONS..."
        mkdir -p android/app/src/main/res/xml
        cp ../capacitor-app/android-patches/AndroidManifest.xml android/app/src/main/res/xml/notification_manifest.xml
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS –≤ AndroidManifest.xml –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS..."
        chmod +x ./add-notification-permission.sh
        ./add-notification-permission.sh
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ç—á–∏–Ω–≥ –≤—Å–µ—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
        chmod +x ./force-patch-manifest.sh
        ./force-patch-manifest.sh
        
        # –ü–∞—Ç—á–∏–º build.gradle –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        echo "–ü–∞—Ç—á–∏–º build.gradle –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –º–µ—Ä–¥–∂–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π..."
        chmod +x ./patch-build-gradle.sh
        ./patch-build-gradle.sh
        
        # –°–æ–∑–¥–∞–µ–º config.xml –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS
        echo "–°–æ–∑–¥–∞–µ–º config.xml –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS..."
        mkdir -p android/app/src/main/res/xml
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>" > android/app/src/main/res/xml/config.xml
        echo "<widget version=\"1.0.0\" xmlns=\"http://www.w3.org/ns/widgets\" xmlns:cdv=\"http://cordova.apache.org/ns/1.0\">" >> android/app/src/main/res/xml/config.xml
        echo "  <feature name=\"Permissions\">" >> android/app/src/main/res/xml/config.xml
        echo "    <param name=\"android-package\" value=\"com.android.plugins.Permissions\"/>" >> android/app/src/main/res/xml/config.xml
        echo "  </feature>" >> android/app/src/main/res/xml/config.xml
        echo "  <preference name=\"AndroidXEnabled\" value=\"true\" />" >> android/app/src/main/res/xml/config.xml
        echo "  <preference name=\"GradlePluginGoogleServicesEnabled\" value=\"true\" />" >> android/app/src/main/res/xml/config.xml
        echo "  <config-file parent=\"/*\" target=\"AndroidManifest.xml\">" >> android/app/src/main/res/xml/config.xml
        echo "    <uses-permission android:name=\"android.permission.POST_NOTIFICATIONS\" tools:targetApi=\"33\" />" >> android/app/src/main/res/xml/config.xml
        echo "  </config-file>" >> android/app/src/main/res/xml/config.xml
        echo "</widget>" >> android/app/src/main/res/xml/config.xml
        echo "‚úÖ config.xml —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
        
        # –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ build.gradle –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS
        echo "–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º build.gradle –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS..."
        if [ -f "android/app/build.gradle" ]; then
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π
          cat > notification_script.txt << 'EOF'

// –ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS
android.applicationVariants.all { variant ->
    variant.outputs.each { output ->
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
        def taskName = "addPostNotificationsTo${variant.name.capitalize()}"
        tasks.register(taskName) {
            doLast {
                def manifestPath = "${buildDir}/intermediates/merged_manifest/${variant.name}/AndroidManifest.xml"
                def manifestFile = file(manifestPath)
                if (manifestFile.exists()) {
                    def manifestText = manifestFile.text
                    if (!manifestText.contains("android.permission.POST_NOTIFICATIONS")) {
                        println "üí° –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS –≤ ${manifestPath}"
                        def updatedText = manifestText.replace("<application", 
                            "<uses-permission android:name=\"android.permission.POST_NOTIFICATIONS\" />\n    <application")
                        manifestFile.write(updatedText)
                        println "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç"
                    } else {
                        println "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ"
                    }
                } else {
                    println "‚ùå –ú–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ${manifestPath}"
                }
            }
        }
        
        // –ò—Å–ø–æ–ª–Ω—è–µ–º –Ω–∞—à —Ç–∞—Å–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
        tasks.matching { it.name == "process${variant.name.capitalize()}Manifest" }.all {
            finalizedBy(taskName)
        }
    }
}
EOF

          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω–µ—Ü build.gradle
          cat notification_script.txt >> android/app/build.gradle
          rm notification_script.txt
          echo "‚úÖ –°–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è POST_NOTIFICATIONS —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω –≤ build.gradle"
        else
          echo "‚ùå –§–∞–π–ª build.gradle –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS..."
          grep -i "POST_NOTIFICATIONS" android/app/src/main/AndroidManifest.xml || {
            echo "‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ! –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ...";
            sed -i '/<manifest/a\\t<uses-permission android:name="android.permission.POST_NOTIFICATIONS" tools:targetApi="33" />' android/app/src/main/AndroidManifest.xml;
          }
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Gradle –≤ Wrapper
        echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è Gradle Wrapper:"
        cat android/gradle/wrapper/gradle-wrapper.properties

    # 8. Android SDK –∏ Gradle setup
    - uses: android-actions/setup-android@v3
    - uses: gradle/gradle-build-action@v3
      with:
        gradle-home-cache-cleanup: true
        gradle-version: 8.11
        arguments: --no-daemon --stacktrace

    # 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gradle Wrapper
    - name: Setup correct Gradle Wrapper
      run: |
        cd capacitor-app/android
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã
        chmod +x ./gradlew || echo "–§–∞–π–ª gradlew –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–±–æ—Ä–∫–∏"
        
        # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π wrapper –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–Ω–æ–≤–æ
        rm -rf gradle/wrapper
        mkdir -p gradle/wrapper
        
        # –°–æ–∑–¥–∞–µ–º gradle-wrapper.properties —Å Gradle 8.11
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.11-all.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω
        cat gradle/wrapper/gradle-wrapper.properties
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º Gradle Wrapper –Ω–∞–ø—Ä—è–º—É—é - –∏—Å–ø–æ–ª—å–∑—É–µ–º JAR –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Gradle
        curl -s -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.11.0/gradle/wrapper/gradle-wrapper.jar
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è wrapper, –µ—Å–ª–∏ gradlew –¥–æ—Å—Ç—É–ø–µ–Ω
        if [ -f "./gradlew" ]; then
          chmod +x ./gradlew
          ./gradlew wrapper --gradle-version 8.11 --distribution-type all
        else
          echo "–§–∞–π–ª gradlew –Ω–µ –Ω–∞–π–¥–µ–Ω, wrapper –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        fi

    # 10. –°–±–æ—Ä–∫–∞ APK —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
    - name: Build unsigned APK
      run: |
        cd capacitor-app/android
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ AndroidManifest.xml –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π:"
        cat app/src/main/AndroidManifest.xml
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è POST_NOTIFICATIONS –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è POST_NOTIFICATIONS –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π:"
        grep -i "POST_NOTIFICATIONS" app/src/main/AndroidManifest.xml || {
          echo "‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ POST_NOTIFICATIONS –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ! –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π...";
          sed -i '/<manifest/a\\t<uses-permission android:name="android.permission.POST_NOTIFICATIONS" tools:targetApi="33" />' app/src/main/AndroidManifest.xml;
        }
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É
        ./gradlew assembleRelease --info
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ —Å–æ–±—Ä–∞–Ω–Ω–æ–º APK
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è POST_NOTIFICATIONS –≤ —Å–æ–±—Ä–∞–Ω–Ω–æ–º APK:"
        find app/build/outputs/apk/release -name "*.apk" | xargs -I{} $ANDROID_HOME/build-tools/34.0.0/aapt dump permissions {} | grep -i POST_NOTIFICATIONS

    # 11. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º APK
    - name: Decode keystore
      run: echo "${{ secrets.KEYSTORE_B64 }}" | base64 -d > keystore.jks
      
    # 11.1 –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SHA1 –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è Firebase)
    - name: Display certificate fingerprint
      run: |
        echo "–û—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (SHA1) –¥–ª—è Firebase:"
        keytool -list -v -keystore keystore.jks -alias "${{ secrets.KEY_ALIAS }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep SHA1

    - name: Sign APK
      run: |
        # –ù–∞—Ö–æ–¥–∏–º APK
        UNSIGNED=$(find capacitor-app/android/app/build/outputs/apk/release -name '*release-unsigned.apk' | head -n 1)
        echo "Unsigned APK: $UNSIGNED"
        
        if [ -z "$UNSIGNED" ]; then
          echo "APK file not found! Checking build directory..."
          find capacitor-app/android/app/build -type f -name "*.apk" || echo "No APK files found!"
          exit 1
        fi
        
        cp "$UNSIGNED" app-unsigned.apk
        
        # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º APK
        APKSIGNER="$ANDROID_HOME/build-tools/34.0.0/apksigner"
        $APKSIGNER sign \
          --ks keystore.jks \
          --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
          --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
          --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
          --out Loans-${{ github.ref_name }}.apk \
          app-unsigned.apk
          
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º
        $APKSIGNER verify --verbose Loans-${{ github.ref_name }}.apk

    # 12. –ü—É–±–ª–∏–∫—É–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: Loans-*.apk
        
    # 13. –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ GitHub Release —Å APK
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Loans-*.apk
        draft: false
        prerelease: false
        name: "–ó–∞–π–º—ã –æ–Ω–ª–∞–π–Ω ${{ github.ref_name }}"
        body: |
          ### –ó–∞–π–º—ã –æ–Ω–ª–∞–π–Ω (–≤–µ—Ä—Å–∏—è ${{ github.ref_name }})
          
          **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
          - –ë—Ä–∞—É–∑–µ—Ä –∑–∞–π–º–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
          - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–π–º–∞–º–∏
          - Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ OneSignal
          
          **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
          - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Capacitor –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤ APK
          - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Firebase –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}